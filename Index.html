<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Negative Gearing Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        input[type="text"], select {
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        input[type="text"]:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        table {
            border-radius: 8px;
            overflow: hidden;
        }
        th {
            background-color: #f0f9ff;
        }
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .text-positive { color: #10b981; }
        .text-negative { color: #ef4444; }
        .text-neutral { color: #4b5563; }
        .ppr-disabled-section {
            opacity: 0.9;
            background-color: #fefce8;
            border: 2px dashed #f59e0b;
        }
        .subdivided-property-section {
            background-color: #e0f7fa;
            border: 2px solid #b3e5fc;
        }
        .sold-property-section {
            opacity: 0.9;
            background-color: #ffebee;
            border: 2px dashed #ef4444;
        }
        .disabled-input {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .summary-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #bae6fd;
        }
        .result-card {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #bbf7d0;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #64748b, #475569);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(100, 116, 139, 0.3);
        }
        .section-title {
            position: relative;
            padding-bottom: 12px;
            margin-bottom: 24px;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 2px;
        }
        .expense-item {
            transition: all 0.2s ease;
            position: relative;
        }
        .expense-item:hover {
            background-color: #f1f5f9;
            transform: translateX(3px);
        }
        .remove-expense-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            padding: 0 5px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .remove-expense-btn:hover {
            opacity: 1;
        }
        .highlight {
            animation: highlight 1.5s ease;
        }
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 py-8">

    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-3">
            Property Negative Gearing Calculator
        </h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Calculate your potential tax benefits and cash flow from investment properties in Australia.
            This tool helps you understand the financial impact of negative gearing on your properties.
        </p>
    </div>

    <div class="bg-white card p-6 w-full max-w-4xl mb-8">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6 section-title">
            Your Financial Details & Assumptions
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="userIncome" class="block text-gray-700 text-sm font-medium mb-2">
                    Your Annual Income ($)
                </label>
                <input
                    type="text"
                    id="userIncome"
                    value="192000"
                    placeholder="e.g., 80000"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <p class="text-xs text-gray-500 mt-1">Your taxable income for the financial year</p>
            </div>
            
            <div class="summary-card p-4 rounded-lg">
                <p class="block text-gray-700 text-sm font-medium mb-2">
                    Calculated Marginal Tax Rate (2025-26 AU):
                </p>
                <p id="calculatedTaxRate" class="text-2xl font-bold text-blue-700">
                    --%
                </p>
                <p class="text-xs text-gray-600 mt-2">
                    (Includes 2% Medicare Levy for calculation simplicity, consult a tax professional for exact figures)
                </p>
            </div>

            <div>
                <label for="rentalGrowthRate" class="block text-gray-700 text-sm font-medium mb-2">
                    Annual Rental Growth Rate (%)
                </label>
                <input
                    type="text"
                    id="rentalGrowthRate"
                    value="2.5"
                    placeholder="e.g., 2.5"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <p class="text-xs text-gray-500 mt-1">Expected annual increase in rental income</p>
            </div>

            <div>
                <label for="expenseInflationRate" class="block text-gray-700 text-sm font-medium mb-2">
                    Annual Expense Inflation Rate (%)
                </label>
                <input
                    type="text"
                    id="expenseInflationRate"
                    value="3.5"
                    placeholder="e.g., 3.5"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <p class="text-xs text-gray-500 mt-1">Expected annual increase in property expenses</p>
            </div>
        </div>
    </div>

    <div class="w-full max-w-7xl mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center section-title">Your Investment Properties</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="propertyCard1" class="bg-white card p-6 flex flex-col h-full">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    Investment Property 1 (Surrey Rd)
                </h2>
                <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="isPPR1" class="form-checkbox h-5 w-5 text-yellow-600 rounded-md" />
                        <span class="text-yellow-800 font-medium">Mark as Principal Place of Residence (PPR)</span>
                    </label>
                    <p class="text-xs text-gray-600 mt-1">
                        (PPR expenses are generally not tax deductible for negative gearing)
                    </p>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-700 mb-3">Rental Income</h3>
                        <div>
                            <label for="weeklyRent1" class="block text-gray-700 text-sm font-medium mb-2">
                                Weekly Rent ($)
                            </label>
                            <input type="text" id="weeklyRent1" value="650" placeholder="e.g., 500" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            Annual Income: <span id="annualRentalIncome1" class="font-semibold"></span>
                        </p>
                    </div>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h3 class="text-lg font-semibold text-indigo-700 mb-3">Loan Details</h3>
                        <div class="mb-3">
                            <label for="loanAmount1" class="block text-gray-700 text-sm font-medium mb-2">
                                Loan Amount ($)
                            </label>
                            <input type="text" id="loanAmount1" value="450000" placeholder="e.g., 500000" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="interestRate1" class="block text-gray-700 text-sm font-medium mb-2">
                                Annual Interest Rate (%)
                            </label>
                            <input type="text" id="interestRate1" value="6.05" placeholder="e.g., 6.5" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="propertyValue1" class="block text-gray-700 text-sm font-medium mb-2">
                                Property Value ($)
                            </label>
                            <input type="text" id="propertyValue1" value="1100000" placeholder="e.g., 1000000" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Estimated market value of the property</p>
                        </div>
                        <div class="mb-3">
                            <label for="landValuePercentage1" class="block text-gray-700 text-sm font-medium mb-2">
                                Land Value Percentage (%)
                            </label>
                            <input type="text" id="landValuePercentage1" value="65" placeholder="e.g., 65" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Percentage of property value attributed to land</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-medium">Monthly P&I:</span> <span id="monthlyPI1" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual P&I:</span> <span id="annualPI1" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Deductible Interest:</span> <span id="deductibleInterest1" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual Principal Paid:</span> <span id="annualPrincipalPaid1" class="font-semibold"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border border-red-200 flex-grow">
                    <h3 class="text-lg font-semibold text-red-700 mb-3 flex justify-between items-center">
                        Deductible Expenses
                        <button type="button" class="add-expense-btn text-blue-500 hover:text-blue-700 text-sm font-semibold" data-property-id="1">
                            + Add Custom
                        </button>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="expensesContainer1">
                        </div>
                    <div class="flex justify-between items-center pt-3 mt-3 border-t border-red-300">
                        <span class="font-medium text-red-700">Total Annual Expenses:</span>
                        <span id="totalAnnualExpenses1" class="font-bold text-red-700 text-lg"></span>
                    </div>
                </div>
            </div>

            <div id="propertyCard2" class="bg-white card p-6 flex flex-col h-full">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    Investment Property 2 (Packham Street)
                </h2>
                <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="isPPR2" class="form-checkbox h-5 w-5 text-yellow-600 rounded-md" />
                        <span class="text-yellow-800 font-medium">Mark as Principal Place of Residence (PPR)</span>
                    </label>
                    <p class="text-xs text-gray-600 mt-1">
                        (PPR expenses are generally not tax deductible for negative gearing)
                    </p>
                </div>
                
                <div class="mb-4 bg-teal-50 p-3 rounded-lg border border-teal-200">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="isSubdivided2" class="form-checkbox h-5 w-5 text-teal-600 rounded-md" />
                        <span class="text-teal-800 font-medium">Subdivide Property 2 (into 2 Townhouses)</span>
                    </label>
                    <p class="text-xs text-gray-600 mt-1">
                        (Enables inputs for Property 2a & 2b below)
                    </p>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-700 mb-3">Rental Income</h3>
                        <div>
                            <label for="weeklyRent2" class="block text-gray-700 text-sm font-medium mb-2">
                                Weekly Rent ($)
                            </label>
                            <input type="text" id="weeklyRent2" value="530" placeholder="e.g., 500" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            Annual Income: <span id="annualRentalIncome2" class="font-semibold"></span>
                        </p>
                    </div>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h3 class="text-lg font-semibold text-indigo-700 mb-3">Loan Details</h3>
                        <div class="mb-3">
                            <label for="loanAmount2" class="block text-gray-700 text-sm font-medium mb-2">
                                Loan Amount ($)
                            </label>
                            <input type="text" id="loanAmount2" value="800000" placeholder="e.g., 500000" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="interestRate2" class="block text-gray-700 text-sm font-medium mb-2">
                                Annual Interest Rate (%)
                            </label>
                            <input type="text" id="interestRate2" value="6.05" placeholder="e.g., 6.5" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="propertyValue2" class="block text-gray-700 text-sm font-medium mb-2">
                                Property Value ($)
                            </label>
                            <input type="text" id="propertyValue2" value="1400000" placeholder="e.g., 1000000" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Estimated market value of the property</p>
                        </div>
                        <div class="mb-3">
                            <label for="landValuePercentage2" class="block text-gray-700 text-sm font-medium mb-2">
                                Land Value Percentage (%)
                            </label>
                            <input type="text" id="landValuePercentage2" value="65" placeholder="e.g., 65" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Percentage of property value attributed to land</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-medium">Monthly P&I:</span> <span id="monthlyPI2" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual P&I:</span> <span id="annualPI2" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Deductible Interest:</span> <span id="deductibleInterest2" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual Principal Paid:</span> <span id="annualPrincipalPaid2" class="font-semibold"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border border-red-200 flex-grow">
                    <h3 class="text-lg font-semibold text-red-700 mb-3 flex justify-between items-center">
                        Deductible Expenses
                        <button type="button" class="add-expense-btn text-blue-500 hover:text-blue-700 text-sm font-semibold" data-property-id="2">
                            + Add Custom
                        </button>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="expensesContainer2">
                        </div>
                    <div class="flex justify-between items-center pt-3 mt-3 border-t border-red-300">
                        <span class="font-medium text-red-700">Total Annual Expenses:</span>
                        <span id="totalAnnualExpenses2" class="font-bold text-red-700 text-lg"></span>
                    </div>
                </div>
            </div>

            <div id="propertyCard2a" class="bg-white card p-6 flex-col h-full hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    Subdivided Property 2a (Townhouse 1)
                </h2>
                <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="isPPR2a" class="form-checkbox h-5 w-5 text-yellow-600 rounded-md" disabled />
                        <span class="text-yellow-800 font-medium">Mark as Principal Place of Residence (PPR)</span>
                    </label>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-700 mb-3">Rental Income</h3>
                        <div>
                            <label for="weeklyRent2a" class="block text-gray-700 text-sm font-medium mb-2">
                                Weekly Rent ($)
                            </label>
                            <input type="text" id="weeklyRent2a" value="300" placeholder="e.g., 500" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            Annual Income: <span id="annualRentalIncome2a" class="font-semibold"></span>
                        </p>
                    </div>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h3 class="text-lg font-semibold text-indigo-700 mb-3">Loan Details</h3>
                        <div class="mb-3">
                            <label for="loanAmount2a" class="block text-gray-700 text-sm font-medium mb-2">
                                Loan Amount ($)
                            </label>
                            <input type="text" id="loanAmount2a" value="400000" placeholder="e.g., 500000" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="interestRate2a" class="block text-gray-700 text-sm font-medium mb-2">
                                Annual Interest Rate (%)
                            </label>
                            <input type="text" id="interestRate2a" value="6.05" placeholder="e.g., 6.5" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="propertyValue2a" class="block text-gray-700 text-sm font-medium mb-2">
                                Property Value ($)
                            </label>
                            <input type="text" id="propertyValue2a" value="700000" placeholder="e.g., 1000000" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Estimated market value of the property</p>
                        </div>
                        <div class="mb-3">
                            <label for="landValuePercentage2a" class="block text-gray-700 text-sm font-medium mb-2">
                                Land Value Percentage (%)
                            </label>
                            <input type="text" id="landValuePercentage2a" value="65" placeholder="e.g., 65" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Percentage of property value attributed to land</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-medium">Monthly P&I:</span> <span id="monthlyPI2a" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual P&I:</span> <span id="annualPI2a" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Deductible Interest:</span> <span id="deductibleInterest2a" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual Principal Paid:</span> <span id="annualPrincipalPaid2a" class="font-semibold"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border border-red-200 flex-grow">
                    <h3 class="text-lg font-semibold text-red-700 mb-3 flex justify-between items-center">
                        Deductible Expenses
                        <button type="button" class="add-expense-btn text-blue-500 hover:text-blue-700 text-sm font-semibold" data-property-id="2a">
                            + Add Custom
                        </button>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="expensesContainer2a">
                        </div>
                    <div class="flex justify-between items-center pt-3 mt-3 border-t border-red-300">
                        <span class="font-medium text-red-700">Total Annual Expenses:</span>
                        <span id="totalAnnualExpenses2a" class="font-bold text-red-700 text-lg"></span>
                    </div>
                </div>
            </div>

            <div id="propertyCard2b" class="bg-white card p-6 flex-col h-full hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    Subdivided Property 2b (Townhouse 2)
                </h2>
                <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="isPPR2b" class="form-checkbox h-5 w-5 text-yellow-600 rounded-md" disabled />
                        <span class="text-yellow-800 font-medium">Mark as Principal Place of Residence (PPR)</span>
                    </label>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-700 mb-3">Rental Income</h3>
                        <div>
                            <label for="weeklyRent2b" class="block text-gray-700 text-sm font-medium mb-2">
                                Weekly Rent ($)
                            </label>
                            <input type="text" id="weeklyRent2b" value="300" placeholder="e.g., 500" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            Annual Income: <span id="annualRentalIncome2b" class="font-semibold"></span>
                        </p>
                    </div>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h3 class="text-lg font-semibold text-indigo-700 mb-3">Loan Details</h3>
                        <div class="mb-3">
                            <label for="loanAmount2b" class="block text-gray-700 text-sm font-medium mb-2">
                                Loan Amount ($)
                            </label>
                            <input type="text" id="loanAmount2b" value="400000" placeholder="e.g., 500000" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="interestRate2b" class="block text-gray-700 text-sm font-medium mb-2">
                                Annual Interest Rate (%)
                            </label>
                            <input type="text" id="interestRate2b" value="6.05" placeholder="e.g., 6.5" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="propertyValue2b" class="block text-gray-700 text-sm font-medium mb-2">
                                Property Value ($)
                            </label>
                            <input type="text" id="propertyValue2b" value="700000" placeholder="e.g., 1000000" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Estimated market value of the property</p>
                        </div>
                        <div class="mb-3">
                            <label for="landValuePercentage2b" class="block text-gray-700 text-sm font-medium mb-2">
                                Land Value Percentage (%)
                            </label>
                            <input type="text" id="landValuePercentage2b" value="65" placeholder="e.g., 65" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Percentage of property value attributed to land</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-medium">Monthly P&I:</span> <span id="monthlyPI2b" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual P&I:</span> <span id="annualPI2b" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Deductible Interest:</span> <span id="deductibleInterest2b" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual Principal Paid:</span> <span id="annualPrincipalPaid2b" class="font-semibold"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border border-red-200 flex-grow">
                    <h3 class="text-lg font-semibold text-red-700 mb-3 flex justify-between items-center">
                        Deductible Expenses
                        <button type="button" class="add-expense-btn text-blue-500 hover:text-blue-700 text-sm font-semibold" data-property-id="2b">
                            + Add Custom
                        </button>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="expensesContainer2b">
                        </div>
                    <div class="flex justify-between items-center pt-3 mt-3 border-t border-red-300">
                        <span class="font-medium text-red-700">Total Annual Expenses:</span>
                        <span id="totalAnnualExpenses2b" class="font-bold text-red-700 text-lg"></span>
                    </div>
                </div>
            </div>

            <div id="propertyCard3" class="bg-white card p-6 flex flex-col h-full">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    Investment Property 3 (Shawlands Avenue)
                </h2>
                <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="isPPR3" class="form-checkbox h-5 w-5 text-yellow-600 rounded-md" />
                        <span class="text-yellow-800 font-medium">Mark as Principal Place of Residence (PPR)</span>
                    </label>
                    <p class="text-xs text-gray-600 mt-1">
                        (PPR expenses are generally not tax deductible for negative gearing)
                    </p>
                </div>
                
                <div class="mb-4 bg-red-100 p-3 rounded-lg border border-red-200">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="isSold3" class="form-checkbox h-5 w-5 text-red-600 rounded-md" />
                        <span class="text-red-800 font-medium">Property Sold in this Financial Year</span>
                    </label>
                    <p class="text-xs text-gray-600 mt-1">
                        (Only income/expenses up to selected month are included for Year 1)
                    </p>
                    <div class="mt-3">
                        <label for="soldMonth3" class="block text-gray-700 text-sm font-medium mb-2">
                            Month Sold (Financial Year starts July)
                        </label>
                        <select id="soldMonth3" class="w-full p-2 border border-gray-300 rounded-md disabled-input" disabled>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December" selected>December</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-700 mb-3">Rental Income</h3>
                        <div>
                            <label for="weeklyRent3" class="block text-gray-700 text-sm font-medium mb-2">
                                Weekly Rent ($)
                            </label>
                            <input type="text" id="weeklyRent3" value="1600" placeholder="e.g., 500" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            Annual Income: <span id="annualRentalIncome3" class="font-semibold"></span>
                        </p>
                    </div>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h3 class="text-lg font-semibold text-indigo-700 mb-3">Loan Details</h3>
                        <div class="mb-3">
                            <label for="loanAmount3" class="block text-gray-700 text-sm font-medium mb-2">
                                Loan Amount ($)
                            </label>
                            <input type="text" id="loanAmount3" value="800000" placeholder="e.g., 500000" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="interestRate3" class="block text-gray-700 text-sm font-medium mb-2">
                                Annual Interest Rate (%)
                            </label>
                            <input type="text" id="interestRate3" value="6.05" placeholder="e.g., 6.5" class="w-full p-2 border border-gray-300 rounded-md" />
                        </div>
                        <div class="mb-3">
                            <label for="propertyValue3" class="block text-gray-700 text-sm font-medium mb-2">
                                Property Value ($)
                            </label>
                            <input type="text" id="propertyValue3" value="2850000" placeholder="e.g., 1000000" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Estimated market value of the property</p>
                        </div>
                        <div class="mb-3">
                            <label for="landValuePercentage3" class="block text-gray-700 text-sm font-medium mb-2">
                                Land Value Percentage (%)
                            </label>
                            <input type="text" id="landValuePercentage3" value="65" placeholder="e.g., 65" class="w-full p-2 border border-gray-300 rounded-md" />
                            <p class="text-xs text-gray-500 mt-1">Percentage of property value attributed to land</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-medium">Monthly P&I:</span> <span id="monthlyPI3" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual P&I:</span> <span id="annualPI3" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Deductible Interest:</span> <span id="deductibleInterest3" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Annual Principal Paid:</span> <span id="annualPrincipalPaid3" class="font-semibold"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border border-red-200 flex-grow">
                    <h3 class="text-lg font-semibold text-red-700 mb-3 flex justify-between items-center">
                        Deductible Expenses
                        <button type="button" class="add-expense-btn text-blue-500 hover:text-blue-700 text-sm font-semibold" data-property-id="3">
                            + Add Custom
                        </button>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="expensesContainer3">
                        </div>
                    <div class="flex justify-between items-center pt-3 mt-3 border-t border-red-300">
                        <span class="font-medium text-red-700">Total Annual Expenses:</span>
                        <span id="totalAnnualExpenses3" class="font-bold text-red-700 text-lg"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-7xl">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center section-title">Calculation Results</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div id="propertyResults1" class="result-card p-5 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-green-800 mb-3 text-center">Property 1 (Surrey Rd)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Weekly Rent:</span>
                        <span id="resWeeklyRent1" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Annual Rental Income:</span>
                        <span id="resAnnualRentalIncome1" class="text-green-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Loan Amount:</span>
                        <span id="resLoanAmount1" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Interest Rate:</span>
                        <span id="resInterestRate1" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Total Expenses:</span>
                        <span id="resTotalExpenses1" class="text-red-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center pt-3" id="resNetRentalLoss1"></div>
                    <div id="resNegativeGearingText1" class="text-center text-purple-600 text-base mt-3"></div>
                    <div id="resTaxBenefit1" class="flex justify-between items-center text-base font-semibold text-orange-600 hidden">
                        <span>Tax Benefit:</span>
                        <span id="taxBenefitAmount1"></span>
                    </div>
                </div>
            </div>
            
            <div id="propertyResults2" class="result-card p-5 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-green-800 mb-3 text-center">Property 2 (Packham Street)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Weekly Rent:</span>
                        <span id="resWeeklyRent2" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Annual Rental Income:</span>
                        <span id="resAnnualRentalIncome2" class="text-green-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Loan Amount:</span>
                        <span id="resLoanAmount2" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Interest Rate:</span>
                        <span id="resInterestRate2" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Total Expenses:</span>
                        <span id="resTotalExpenses2" class="text-red-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center pt-3" id="resNetRentalLoss2"></div>
                    <div id="resNegativeGearingText2" class="text-center text-purple-600 text-base mt-3"></div>
                    <div id="resTaxBenefit2" class="flex justify-between items-center text-base font-semibold text-orange-600 hidden">
                        <span>Tax Benefit:</span>
                        <span id="taxBenefitAmount2"></span>
                    </div>
                </div>
            </div>

            <div id="propertyResults2a" class="result-card p-5 rounded-xl shadow-sm hidden">
                <h3 class="text-lg font-bold text-green-800 mb-3 text-center">Property 2a (Townhouse 1)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Weekly Rent:</span>
                        <span id="resWeeklyRent2a" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Annual Rental Income:</span>
                        <span id="resAnnualRentalIncome2a" class="text-green-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Loan Amount:</span>
                        <span id="resLoanAmount2a" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Interest Rate:</span>
                        <span id="resInterestRate2a" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Total Expenses:</span>
                        <span id="resTotalExpenses2a" class="text-red-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center pt-3" id="resNetRentalLoss2a"></div>
                    <div id="resNegativeGearingText2a" class="text-center text-purple-600 text-base mt-3"></div>
                    <div id="resTaxBenefit2a" class="flex justify-between items-center text-base font-semibold text-orange-600 hidden">
                        <span>Tax Benefit:</span>
                        <span id="taxBenefitAmount2a"></span>
                    </div>
                </div>
            </div>

            <div id="propertyResults2b" class="result-card p-5 rounded-xl shadow-sm hidden">
                <h3 class="text-lg font-bold text-green-800 mb-3 text-center">Property 2b (Townhouse 2)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Weekly Rent:</span>
                        <span id="resWeeklyRent2b" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Annual Rental Income:</span>
                        <span id="resAnnualRentalIncome2b" class="text-green-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Loan Amount:</span>
                        <span id="resLoanAmount2b" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Interest Rate:</span>
                        <span id="resInterestRate2b" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Total Expenses:</span>
                        <span id="resTotalExpenses2b" class="text-red-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center pt-3" id="resNetRentalLoss2b"></div>
                    <div id="resNegativeGearingText2b" class="text-center text-purple-600 text-base mt-3"></div>
                    <div id="resTaxBenefit2b" class="flex justify-between items-center text-base font-semibold text-orange-600 hidden">
                        <span>Tax Benefit:</span>
                        <span id="taxBenefitAmount2b"></span>
                    </div>
                </div>
            </div>
            
            <div id="propertyResults3" class="result-card p-5 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-green-800 mb-3 text-center">Property 3 (Shawlands Avenue)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Weekly Rent:</span>
                        <span id="resWeeklyRent3" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Annual Rental Income:</span>
                        <span id="resAnnualRentalIncome3" class="text-green-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Loan Amount:</span>
                        <span id="resLoanAmount3" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Interest Rate:</span>
                        <span id="resInterestRate3" class="font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium">Total Expenses:</span>
                        <span id="resTotalExpenses3" class="text-red-600 font-semibold text-lg"></span>
                    </div>
                    <div class="flex justify-between items-center pt-3" id="resNetRentalLoss3"></div>
                    <div id="resNegativeGearingText3" class="text-center text-purple-600 text-base mt-3"></div>
                    <div id="resTaxBenefit3" class="flex justify-between items-center text-base font-semibold text-orange-600 hidden">
                        <span>Tax Benefit:</span>
                        <span id="taxBenefitAmount3"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card p-6 rounded-xl mb-8">
            <h3 class="text-xl font-bold text-blue-800 mb-4 text-center section-title">Overall Summary</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                    <span class="font-medium">Combined Annual Income:</span>
                    <span id="overallTotalIncome" class="text-blue-700 font-semibold text-lg"></span>
                </div>
                <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                    <span class="font-medium">Combined Deductible Expenses:</span>
                    <span id="overallTotalExpenses" class="text-blue-700 font-semibold text-lg"></span>
                </div>
                <div id="overallNetRentalLoss" class="flex justify-between items-center p-4 bg-white rounded-lg"></div>
                <div id="overallNegativeGearingText" class="text-center text-lg p-3 bg-white rounded-lg"></div>
                <div id="potentialTaxBenefitContainer" class="flex justify-between items-center p-4 bg-orange-50 rounded-lg text-orange-700 font-bold hidden">
                    <span>Potential Tax Benefit:</span>
                    <span id="potentialTaxBenefit"></span>
                </div>
                <p id="taxBenefitNote" class="text-center text-sm text-gray-600 mt-2 hidden">
                    (Calculated as Overall Net Rental Loss  Your Marginal Tax Rate)
                </p>
                <div class="flex justify-center mt-4">
                    <button id="calculateTaxBenefitButton" class="btn-primary font-bold py-2 px-6 rounded-lg hidden">
                        Calculate Latest Income Tax Benefit
                    </button>
                </div>
                <div class="flex justify-between items-center p-3 bg-white rounded-lg mt-4">
                    <span class="font-medium">Total Annual Principal Paid:</span>
                    <span id="overallAnnualPrincipalPaid" class="text-blue-700 font-semibold text-lg"></span>
                </div>
                <div id="overallEndOfYearCashFlow" class="flex justify-between items-center p-4 bg-blue-100 rounded-lg text-blue-800 font-bold text-lg mt-4">
                    <span>Overall End of Year Cash Flow:</span>
                    <span id="cashFlowAmount"></span>
                </div>
                <p class="text-center text-xs text-gray-600 mt-2">
                    (Your Income + All Rents - Interest Expenses - All Actual Expenses Excluding Depreciation - Principal Payments)
                </p>
            </div>
        </div>

        <div class="bg-white card p-6 mb-8">
            <h3 class="text-xl font-bold text-blue-800 mb-4 text-center section-title">5-Year Cash Flow Projection</h3>
            <div class="overflow-x-auto">
                <table id="cashFlowTable" class="min-w-full">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-left">Year</th>
                            <th class="py-3 px-4 text-right">Rental Income</th>
                            <th class="py-3 px-4 text-right">Deductible Expenses</th>
                            <th class="py-3 px-4 text-right">Net Rental Income/Loss</th>
                            <th class="py-3 px-4 text-right">Tax Benefit</th>
                            <th class="py-3 px-4 text-right">Net Cash Flow After Tax</th>
                            <th class="py-3 px-4 text-right">Principal Repayments</th>
                            <th class="py-3 px-4 text-right">Overall Cash Flow</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <p class="text-xs text-gray-600 mt-4 text-center">
                * This projection assumes consistent interest rates. Rental income and fixed expenses are adjusted by specified growth/inflation rates.
            </p>
        </div>

        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4 mb-8">
            <button id="resetButton" class="btn-secondary font-bold py-3 px-8 rounded-lg">
                Reset All Fields
            </button>
            <button id="saveButton" class="btn-primary font-bold py-3 px-8 rounded-lg">
                Save Calculation
            </button>
            <button id="loadButton" class="btn-secondary font-bold py-3 px-8 rounded-lg">
                Load Saved Calculation
            </button>
        </div>
    </div>

    <footer class="mt-8 text-center text-gray-600 text-sm w-full max-w-7xl">
        <div class="border-t border-gray-200 pt-4">
            <p>Property Negative Gearing Calculator &copy; 2025 | This tool provides estimates only. Consult a financial advisor for professional advice.</p>
        </div>
    </footer>

    <script>
        // Helper function to safely parse float values
        const parseNumber = (value) => {
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        };

        // Helper to format currency
        const formatCurrency = (value) => {
            return '$' + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // Function to calculate the marginal tax rate based on Australian tax brackets (2025-2026 financial year)
        const calculateMarginalTaxRate = (income) => {
            let taxRate = 0;
            const medicareLevy = 0.02; // 2% Medicare Levy

            if (income <= 18200) {
                taxRate = 0;
            } else if (income <= 45000) {
                taxRate = 0.16;
            } else if (income <= 135000) {
                taxRate = 0.30;
            } else if (income <= 190000) {
                taxRate = 0.37;
            } else {
                taxRate = 0.45;
            }
            return taxRate + medicareLevy;
        };

        // Function to calculate mortgage amortization
        const calculateMortgageAmortization = (principal, annualInterestRate, loanTermYears = 30, numYearsToProject = 5) => {
            const amortizationSchedule = [];
            if (principal <= 0 || annualInterestRate < 0 || loanTermYears <= 0) {
                for (let i = 0; i < numYearsToProject; i++) {
                    amortizationSchedule.push({ monthlyPayment: 0, annualInterest: 0, annualPrincipal: 0, remainingBalance: 0 });
                }
                return amortizationSchedule;
            }

            const monthlyInterestRate = (annualInterestRate / 100) / 12;
            const numberOfPayments = loanTermYears * 12;

            let monthlyPayment;
            if (monthlyInterestRate === 0) {
                monthlyPayment = principal / numberOfPayments;
            } else {
                monthlyPayment = principal * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
            }

            let currentRemainingBalance = principal;

            for (let year = 0; year < numYearsToProject; year++) {
                let annualInterestAccrued = 0;
                let annualPrincipalPaid = 0;

                for (let month = 0; month < 12; month++) {
                    if (currentRemainingBalance <= 0) {
                        currentRemainingBalance = 0;
                        break;
                    }
                    const interestThisMonth = currentRemainingBalance * monthlyInterestRate;
                    const principalThisMonth = Math.min(monthlyPayment - interestThisMonth, currentRemainingBalance);

                    annualInterestAccrued += interestThisMonth;
                    annualPrincipalPaid += principalThisMonth;
                    currentRemainingBalance -= principalThisMonth;
                }
                const yearResult = {
                    monthlyPayment: monthlyPayment,
                    annualInterest: annualInterestAccrued,
                    annualPrincipal: annualPrincipalPaid,
                    remainingBalance: Math.max(0, currentRemainingBalance)
                };
                amortizationSchedule.push(yearResult);
            }
            return amortizationSchedule;
        };

        // Function to calculate Land Tax based on SRO Victoria 2024 General Rates
        const calculateLandTax = (landValue) => {
            if (landValue <= 300000) {
                return 0;
            } else if (landValue <= 600000) {
                return 275 + 0.002 * (landValue - 300000);
            } else if (landValue <= 1000000) {
                return 875 + 0.003 * (landValue - 600000);
            } else if (landValue <= 1800000) {
                return 2075 + 0.005 * (landValue - 1000000);
            } else if (landValue <= 3000000) {
                return 6075 + 0.007 * (landValue - 1800000);
            } else if (landValue <= 4500000) {
                return 14475 + 0.009 * (landValue - 3000000);
            } else if (landValue <= 6000000) {
                return 27975 + 0.012 * (landValue - 4500000);
            } else if (landValue <= 9000000) {
                return 45975 + 0.015 * (landValue - 6000000);
            } else if (landValue <= 15000000) {
                return 90975 + 0.018 * (landValue - 9000000);
            } else if (landValue <= 25000000) {
                return 198975 + 0.020 * (landValue - 15000000);
            } else {
                return 398975 + 0.0225 * (landValue - 25000000);
            }
        };

        // Default expenses configuration
        const defaultExpenses = {
            '1': [
                { id: 'councilRates1', label: 'Council Rates ($)', value: 2500 },
                { id: 'waterRates1', label: 'Water Rates ($)', value: 800 },
                { id: 'landTax1', label: 'Land Tax ($)', value: 0, isLandTax: true }, // Value will be calculated
                { id: 'bodyCorporateFees1', label: 'Body Corporate Fees ($)', value: 2000 },
                { id: 'propertyManagementFees1', label: 'Property Management Fees (5.5% of Rent)', value: 0, isAgentFee: true },
                { id: 'annualMaintenance1', label: 'Annual Maintenance ($)', value: 500 },
                { id: 'insurance1', label: 'Insurance ($)', value: 1200 },
                { id: 'gardening1', label: 'Gardening/Lawn Mowing ($)', value: 400 },
                { id: 'emergencyHomeAssistance1', label: 'Emergency Home Assistance ($)', value: 400 },
                { id: 'complianceCheck1', label: 'Compliance Check ($)', value: 400 },
                { id: 'depreciation1', label: 'Depreciation ($)', value: 0, isDepreciation: true },
                { id: 'loanApplicationFees1', label: 'Loan Fees ($)', value: 0 }
            ],
            '2': [
                { id: 'councilRates2', label: 'Council Rates ($)', value: 3500 },
                { id: 'waterRates2', label: 'Water Rates ($)', value: 700 },
                { id: 'landTax2', label: 'Land Tax ($)', value: 0, isLandTax: true }, // Value will be calculated
                { id: 'bodyCorporateFees2', label: 'Body Corporate Fees ($)', value: 0 },
                { id: 'propertyManagementFees2', label: 'Property Management Fees (5.5% of Rent)', value: 0, isAgentFee: true },
                { id: 'annualMaintenance2', label: 'Annual Maintenance ($)', value: 500 },
                { id: 'insurance2', label: 'Insurance ($)', value: 1100 },
                { id: 'gardening2', label: 'Gardening/Lawn Mowing ($)', value: 350 },
                { id: 'emergencyHomeAssistance2', label: 'Emergency Home Assistance ($)', value: 400 },
                { id: 'complianceCheck2', label: 'Compliance Check ($)', value: 400 },
                { id: 'depreciation2', label: 'Depreciation ($)', value: 0, isDepreciation: true },
                { id: 'loanApplicationFees2', label: 'Loan Fees ($)', value: 0 }
            ],
            '2a': [
                { id: 'councilRates2a', label: 'Council Rates ($)', value: 1750 },
                { id: 'waterRates2a', label: 'Water Rates ($)', value: 350 },
                { id: 'landTax2a', label: 'Land Tax ($)', value: 0, isLandTax: true }, // Value will be calculated
                { id: 'bodyCorporateFees2a', label: 'Body Corporate Fees ($)', value: 0 },
                { id: 'propertyManagementFees2a', label: 'Property Management Fees (5.5% of Rent)', value: 0, isAgentFee: true },
                { id: 'annualMaintenance2a', label: 'Annual Maintenance ($)', value: 250 },
                { id: 'insurance2a', label: 'Insurance ($)', value: 550 },
                { id: 'gardening2a', label: 'Gardening/Lawn Mowing ($)', value: 175 },
                { id: 'emergencyHomeAssistance2a', label: 'Emergency Home Assistance ($)', value: 200 },
                { id: 'complianceCheck2a', label: 'Compliance Check ($)', value: 200 },
                { id: 'depreciation2a', label: 'Depreciation ($)', value: 0, isDepreciation: true },
                { id: 'loanApplicationFees2a', label: 'Loan Fees ($)', value: 0 }
            ],
            '2b': [
                { id: 'councilRates2b', label: 'Council Rates ($)', value: 1750 },
                { id: 'waterRates2b', label: 'Water Rates ($)', value: 350 },
                { id: 'landTax2b', label: 'Land Tax ($)', value: 0, isLandTax: true }, // Value will be calculated
                { id: 'bodyCorporateFees2b', label: 'Body Corporate Fees ($)', value: 0 },
                { id: 'propertyManagementFees2b', label: 'Property Management Fees (5.5% of Rent)', value: 0, isAgentFee: true },
                { id: 'annualMaintenance2b', label: 'Annual Maintenance ($)', value: 250 },
                { id: 'insurance2b', label: 'Insurance ($)', value: 550 },
                { id: 'gardening2b', label: 'Gardening/Lawn Mowing ($)', value: 175 },
                { id: 'emergencyHomeAssistance2b', label: 'Emergency Home Assistance ($)', value: 200 },
                { id: 'complianceCheck2b', label: 'Compliance Check ($)', value: 200 },
                { id: 'depreciation2b', label: 'Depreciation ($)', value: 0, isDepreciation: true },
                { id: 'loanApplicationFees2b', label: 'Loan Fees ($)', value: 0 }
            ],
            '3': [
                { id: 'councilRates3', label: 'Council Rates ($)', value: 3800 },
                { id: 'waterRates3', label: 'Water Rates ($)', value: 750 },
                { id: 'landTax3', label: 'Land Tax ($)', value: 0, isLandTax: true }, // Value will be calculated
                { id: 'bodyCorporateFees3', label: 'Body Corporate Fees ($)', value: 0 },
                { id: 'propertyManagementFees3', label: 'Property Management Fees (5.5% of Rent)', value: 0, isAgentFee: true },
                { id: 'annualMaintenance3', label: 'Annual Maintenance ($)', value: 500 },
                { id: 'insurance3', label: 'Insurance ($)', value: 1150 },
                { id: 'gardening3', label: 'Gardening/Lawn Mowing ($)', value: 380 },
                { id: 'emergencyHomeAssistance3', label: 'Emergency Home Assistance ($)', value: 400 },
                { id: 'complianceCheck3', label: 'Compliance Check ($)', value: 400 },
                { id: 'depreciation3', label: 'Depreciation ($)', value: 70000, isDepreciation: true },
                { id: 'loanApplicationFees3', label: 'Loan Fees ($)', value: 0 }
            ]
        };

        let currentExpenses = JSON.parse(JSON.stringify(defaultExpenses)); // Deep copy for mutable state

        // Function to render/re-render expense inputs for a given property
        const renderExpenses = (propertyId) => {
            const expensesContainer = document.getElementById(`expensesContainer${propertyId}`);
            if (!expensesContainer) return;

            expensesContainer.innerHTML = ''; // Clear existing inputs

            currentExpenses[propertyId].forEach(expense => {
                const expenseDiv = document.createElement('div');
                expenseDiv.className = 'expense-item relative';

                let inputValue = expense.value;
                // If it's an agent fee, calculate its default value based on current weekly rent
                if (expense.isAgentFee) {
                    const weeklyRentInputId = `weeklyRent${propertyId}`;
                    const weeklyRent = parseNumber(document.getElementById(weeklyRentInputId)?.value || 0);
                    inputValue = weeklyRent * 52 * 0.055; // 5.5% of annual rent
                    // Update the value in currentExpenses so it's saved/loaded correctly
                    expense.value = inputValue; 
                } else if (expense.isLandTax) {
                    const propertyValue = parseNumber(document.getElementById(`propertyValue${propertyId}`)?.value || 0);
                    const landValuePercentage = parseNumber(document.getElementById(`landValuePercentage${propertyId}`)?.value || 0);
                    const landValue = propertyValue * (landValuePercentage / 100);
                    inputValue = calculateLandTax(landValue);
                    expense.value = inputValue; // Update the value in currentExpenses
                }


                expenseDiv.innerHTML = `
                    <label for="${expense.id}" class="block text-gray-700 text-sm font-medium mb-1">${expense.label}</label>
                    <input type="text" id="${expense.id}" value="${inputValue.toFixed(2)}" placeholder="0" class="w-full p-2 border border-gray-300 rounded-md" data-expense-name="${expense.label}" data-is-depreciation="${expense.isDepreciation || false}" data-is-land-tax="${expense.isLandTax || false}" />
                    <button type="button" class="remove-expense-btn" data-expense-id="${expense.id}">&times;</button>
                `;
                expensesContainer.appendChild(expenseDiv);

                // Add event listeners for the new input and remove button
                const inputElement = expenseDiv.querySelector(`#${expense.id}`);
                inputElement.addEventListener('input', calculateAll);

                const removeButton = expenseDiv.querySelector('.remove-expense-btn');
                removeButton.addEventListener('click', (event) => {
                    const expenseToRemoveId = event.target.dataset.expenseId;
                    currentExpenses[propertyId] = currentExpenses[propertyId].filter(e => e.id !== expenseToRemoveId);
                    renderExpenses(propertyId); // Re-render to remove the item
                    calculateAll(); // Recalculate after removal
                });
            });
        };

        // Function to add a custom expense input field
        const addCustomExpenseField = (propertyId) => {
            const uniqueId = `customExpense${propertyId}_${Date.now()}`;
            currentExpenses[propertyId].push({ id: uniqueId, label: 'Custom Expense ($)', value: 0, isCustom: true });
            renderExpenses(propertyId); // Re-render to include the new item
            calculateAll(); // Recalculate after adding
        };

        // Function to calculate individual property details
        const calculateProperty = (propertyId) => {
            const isPPR = document.getElementById(`isPPR${propertyId}`).checked;
            const isSold = document.getElementById(`isSold${propertyId}`) ? document.getElementById(`isSold${propertyId}`).checked : false;
            const soldMonthIndex = isSold ? document.getElementById(`soldMonth${propertyId}`).selectedIndex : 11; // 0-indexed, Dec is 5, June is 11
            const monthsActive = isSold ? (soldMonthIndex + 1) : 12; // Number of months property was active in Year 1

            const weeklyRent = parseNumber(document.getElementById(`weeklyRent${propertyId}`).value);
            const loanAmount = parseNumber(document.getElementById(`loanAmount${propertyId}`).value);
            const interestRate = parseNumber(document.getElementById(`interestRate${propertyId}`).value);
            const propertyValue = parseNumber(document.getElementById(`propertyValue${propertyId}`).value); // Get property value
            const landValuePercentage = parseNumber(document.getElementById(`landValuePercentage${propertyId}`).value);
            const landValue = propertyValue * (landValuePercentage / 100);


            const annualRentalIncome = weeklyRent * 52;

            // Calculate loan amortization for 5 years
            const loanAmortization = calculateMortgageAmortization(loanAmount, interestRate, 30, 5);
            const currentYearAmortization = loanAmortization[0] || { monthlyPayment: 0, annualInterest: 0, annualPrincipal: 0 };

            const monthlyPI = currentYearAmortization.monthlyPayment;
            const annualPI = monthlyPI * 12;
            const deductibleInterest = currentYearAmortization.annualInterest;
            const annualPrincipalPaid = currentYearAmortization.annualPrincipal;

            let totalFixedExpenses = 0; // All expenses including depreciation
            let totalActualExpensesExcludingDepreciation = 0; // For overall cash flow calculation

            // Get values from rendered expense inputs
            const expenseInputs = document.querySelectorAll(`#expensesContainer${propertyId} input[type="text"]`);
            expenseInputs.forEach(input => {
                const expenseValue = parseNumber(input.value);
                totalFixedExpenses += expenseValue;
                if (input.dataset.isDepreciation !== 'true') { // Check if it's not a depreciation expense
                    totalActualExpensesExcludingDepreciation += expenseValue;
                }
            });

            // Update total annual expenses display on the property card
            document.getElementById(`totalAnnualExpenses${propertyId}`).textContent = formatCurrency(totalFixedExpenses);

            // Adjust income and expenses for 'sold' property for Year 1
            let adjustedAnnualRentalIncome = annualRentalIncome;
            let adjustedTotalFixedExpenses = totalFixedExpenses; // Total expenses for the property card display
            let adjustedTotalDeductibleExpenses = totalFixedExpenses + deductibleInterest; // For negative gearing calculation
            let adjustedDeductibleInterest = deductibleInterest;
            let adjustedAnnualPrincipalPaid = annualPrincipalPaid;
            let adjustedTotalActualExpensesExcludingDepreciation = totalActualExpensesExcludingDepreciation;


            if (isSold) {
                adjustedAnnualRentalIncome = (annualRentalIncome / 12) * monthsActive;
                adjustedTotalFixedExpenses = (totalFixedExpenses / 12) * monthsActive; // Adjusted for display on card
                adjustedDeductibleInterest = (deductibleInterest / 12) * monthsActive;
                adjustedTotalDeductibleExpenses = adjustedTotalFixedExpenses + adjustedDeductibleInterest; // Adjusted for negative gearing
                adjustedAnnualPrincipalPaid = (annualPrincipalPaid / 12) * monthsActive;
                adjustedTotalActualExpensesExcludingDepreciation = (totalActualExpensesExcludingDepreciation / 12) * monthsActive;
            }


            const netRentalLoss = adjustedAnnualRentalIncome - adjustedTotalDeductibleExpenses;

            // Update UI
            document.getElementById(`annualRentalIncome${propertyId}`).textContent = formatCurrency(annualRentalIncome);
            document.getElementById(`monthlyPI${propertyId}`).textContent = formatCurrency(monthlyPI);
            document.getElementById(`annualPI${propertyId}`).textContent = formatCurrency(annualPI);
            document.getElementById(`deductibleInterest${propertyId}`).textContent = formatCurrency(deductibleInterest);
            document.getElementById(`annualPrincipalPaid${propertyId}`).textContent = formatCurrency(annualPrincipalPaid);

            // Update results card
            document.getElementById(`resWeeklyRent${propertyId}`).textContent = formatCurrency(weeklyRent);
            document.getElementById(`resAnnualRentalIncome${propertyId}`).textContent = formatCurrency(adjustedAnnualRentalIncome);
            document.getElementById(`resLoanAmount${propertyId}`).textContent = formatCurrency(loanAmount);
            document.getElementById(`resInterestRate${propertyId}`).textContent = `${interestRate}%`;
            document.getElementById(`resTotalExpenses${propertyId}`).textContent = formatCurrency(adjustedTotalDeductibleExpenses); // This includes interest

            const resNetRentalLossEl = document.getElementById(`resNetRentalLoss${propertyId}`);
            resNetRentalLossEl.innerHTML = `<span>Net Rental Income/Loss:</span><span class="${netRentalLoss < 0 ? 'text-negative' : 'text-positive'} font-bold text-lg">${formatCurrency(netRentalLoss)}</span>`;

            const resNegativeGearingTextEl = document.getElementById(`resNegativeGearingText${propertyId}`);
            const resTaxBenefitEl = document.getElementById(`resTaxBenefit${propertyId}`);
            const taxBenefitAmountEl = document.getElementById(`taxBenefitAmount${propertyId}`);

            // Get all inputs for this property card to manage their disabled state
            const propertyCardInputs = document.querySelectorAll(`#propertyCard${propertyId} input[type="text"], #propertyCard${propertyId} select, #propertyCard${propertyId} .add-expense-btn, #propertyCard${propertyId} .remove-expense-btn`);

            if (isPPR) {
                // If PPR, expenses are not deductible for negative gearing purposes
                resNetRentalLossEl.innerHTML = `<span>Net Rental Income/Loss:</span><span class="text-neutral font-bold text-lg">${formatCurrency(annualRentalIncome - (totalFixedExpenses + annualPrincipalPaid))}</span>`; // Show actual cash flow if PPR
                resNegativeGearingTextEl.className = "text-center text-gray-600 text-base mt-3";
                resNegativeGearingTextEl.textContent = "This is marked as Principal Place of Residence (PPR). Expenses are generally not tax deductible for negative gearing.";
                resTaxBenefitEl.classList.add('hidden');
                document.getElementById(`propertyCard${propertyId}`).classList.add('ppr-disabled-section');
                document.getElementById(`propertyResults${propertyId}`).classList.add('ppr-disabled-section');
                
                propertyCardInputs.forEach(input => {
                    input.classList.add('disabled-input');
                    input.disabled = true;
                });
                // Re-enable PPR checkbox itself
                document.getElementById(`isPPR${propertyId}`).disabled = false;
            } else {
                document.getElementById(`propertyCard${propertyId}`).classList.remove('ppr-disabled-section');
                document.getElementById(`propertyResults${propertyId}`).classList.remove('ppr-disabled-section');
                
                propertyCardInputs.forEach(input => {
                    input.classList.remove('disabled-input');
                    input.disabled = false;
                });
                // Re-enable PPR checkbox itself
                document.getElementById(`isPPR${propertyId}`).disabled = false;

                if (netRentalLoss < 0) {
                    resNegativeGearingTextEl.className = "text-center text-purple-600 text-base mt-3";
                    resNegativeGearingTextEl.textContent = `This property is negatively geared with a deduction of ${formatCurrency(Math.abs(netRentalLoss))}.`;
                    resTaxBenefitEl.classList.remove('hidden');
                    taxBenefitAmountEl.textContent = formatCurrency(Math.abs(netRentalLoss) * calculateMarginalTaxRate(parseNumber(document.getElementById('userIncome').value)));
                } else {
                    resNegativeGearingTextEl.className = "text-center text-green-600 text-base mt-3";
                    resNegativeGearingTextEl.textContent = "This property is positively geared.";
                    resTaxBenefitEl.classList.add('hidden');
                }
            }

            // Handle sold property styling and input disabling
            const propertyCardEl = document.getElementById(`propertyCard${propertyId}`);
            const soldMonthSelect = document.getElementById(`soldMonth${propertyId}`);
            if (isSold) {
                propertyCardEl.classList.add('sold-property-section');
                document.getElementById(`propertyResults${propertyId}`).classList.add('sold-property-section');
                if (soldMonthSelect) soldMonthSelect.disabled = false;
            } else {
                propertyCardEl.classList.remove('sold-property-section');
                document.getElementById(`propertyResults${propertyId}`).classList.remove('sold-property-section');
                if (soldMonthSelect) soldMonthSelect.disabled = true;
            }
            
            return {
                propertyId,
                isPPR,
                isSold,
                monthsActive,
                weeklyRent,
                annualRentalIncome, // Current year income (pre-adjusted for sold)
                loanAmount,
                interestRate,
                propertyValue, // Added property value
                landValuePercentage, // Added land value percentage
                landValue, // Calculated land value
                monthlyPI,
                annualPI,
                deductibleInterest, // Current year interest (pre-adjusted for sold)
                annualPrincipalPaid, // Current year principal (pre-adjusted for sold)
                totalFixedExpenses, // Total fixed expenses for the property (pre-adjusted for sold)
                totalDeductibleExpenses: adjustedTotalDeductibleExpenses, // Adjusted for sold property and includes interest
                netRentalLoss: netRentalLoss, // Adjusted for sold property
                loanAmortization, // Full 5-year amortization schedule
                totalActualExpensesExcludingDepreciation: totalActualExpensesExcludingDepreciation // Pre-adjusted for sold
            };
        };

        // Function to populate the cash flow table
        const populateCashFlowTable = (propertiesData, userIncome, rentalGrowthRate, expenseInflationRate) => {
            const tableBody = document.getElementById('cashFlowTable').querySelector('tbody');
            tableBody.innerHTML = ''; // Clear previous rows

            const marginalTaxRate = calculateMarginalTaxRate(userIncome);

            for (let year = 0; year < 5; year++) {
                let totalRentalIncomeYear = 0;
                let totalDeductibleExpensesYear = 0; // For tax calculation
                let totalPrincipalRepaymentsYear = 0;
                let totalActualExpensesExcludingDepreciationYear = 0; // For overall cash flow calculation

                propertiesData.forEach(prop => {
                    if (!prop) return; // Skip if property data is null

                    let currentAnnualRentalIncome = prop.annualRentalIncome * Math.pow(1 + rentalGrowthRate / 100, year);
                    let currentTotalFixedExpenses = prop.totalFixedExpenses * Math.pow(1 + expenseInflationRate / 100, year);
                    let currentTotalActualExpensesExcludingDepreciation = prop.totalActualExpensesExcludingDepreciation * Math.pow(1 + expenseInflationRate / 100, year);
                    
                    // Get interest and principal for the specific year from amortization schedule
                    const annualInterestThisYear = (prop.loanAmortization[year] && prop.loanAmortization[year].annualInterest) ? prop.loanAmortization[year].annualInterest : 0;
                    const annualPrincipalThisYear = (prop.loanAmortization[year] && prop.loanAmortization[year].annualPrincipal) ? prop.loanAmortization[year].annualPrincipal : 0;

                    let currentTotalDeductibleExpensesForTax = currentTotalFixedExpenses + annualInterestThisYear;

                    // For Year 1, apply 'sold' property adjustment if applicable
                    if (year === 0 && prop.isSold) {
                        currentAnnualRentalIncome = (prop.annualRentalIncome / 12) * prop.monthsActive;
                        currentTotalFixedExpenses = (prop.totalFixedExpenses / 12) * prop.monthsActive;
                        const adjustedAnnualInterestThisYear = (annualInterestThisYear / 12) * prop.monthsActive;
                        currentTotalDeductibleExpensesForTax = currentTotalFixedExpenses + adjustedAnnualInterestThisYear;
                        currentTotalActualExpensesExcludingDepreciation = (prop.totalActualExpensesExcludingDepreciation / 12) * prop.monthsActive;
                    }

                    // Only include income/expenses for tax calculation if not PPR
                    if (!prop.isPPR) {
                        totalRentalIncomeYear += currentAnnualRentalIncome;
                        totalDeductibleExpensesYear += currentTotalDeductibleExpensesForTax;
                    }
                    // Principal repayments and cash expenses are always part of cash flow, regardless of PPR status
                    totalPrincipalRepaymentsYear += annualPrincipalThisYear;
                    totalActualExpensesExcludingDepreciationYear += currentTotalActualExpensesExcludingDepreciation;
                });

                const netRentalIncomeLossYear = totalRentalIncomeYear - totalDeductibleExpensesYear;
                const taxBenefitYear = netRentalIncomeLossYear < 0 ? Math.abs(netRentalIncomeLossYear) * marginalTaxRate : 0;
                const netCashFlowAfterTax = netRentalIncomeLossYear + taxBenefitYear;
                const overallCashFlow = netCashFlowAfterTax - totalPrincipalRepaymentsYear;

                const row = tableBody.insertRow();
                row.insertCell().textContent = `Year ${year + 1}`;
                row.insertCell().textContent = formatCurrency(totalRentalIncomeYear);
                row.insertCell().textContent = formatCurrency(totalDeductibleExpensesYear);
                row.insertCell().textContent = formatCurrency(netRentalIncomeLossYear);
                row.insertCell().textContent = formatCurrency(taxBenefitYear);
                row.insertCell().textContent = formatCurrency(netCashFlowAfterTax);
                row.insertCell().textContent = formatCurrency(totalPrincipalRepaymentsYear);
                row.insertCell().textContent = formatCurrency(overallCashFlow);

                // Apply color coding to Net Rental Income/Loss and Overall Cash Flow
                row.cells[3].classList.add(netRentalIncomeLossYear < 0 ? 'text-negative' : 'text-positive', 'font-semibold');
                row.cells[7].classList.add(overallCashFlow < 0 ? 'text-negative' : 'text-positive', 'font-semibold');
                row.cells[1].classList.add('text-green-600');
                row.cells[2].classList.add('text-red-600');
                row.cells[4].classList.add('text-orange-600');
            }
        };

        // Main calculation function
        const calculateAll = () => {
            try {
                // Get global growth and inflation rates
                const rentalGrowthRate = parseNumber(document.getElementById('rentalGrowthRate').value);
                const expenseInflationRate = parseNumber(document.getElementById('expenseInflationRate').value);

                const isSubdivided2El = document.getElementById('isSubdivided2');
                const isPPR2El = document.getElementById('isPPR2');
                const isPPR2aEl = document.getElementById('isPPR2a');
                const isPPR2bEl = document.getElementById('isPPR2b');

                const propertyCard2 = document.getElementById('propertyCard2');
                const propertyResults2 = document.getElementById('propertyResults2');
                const propertyCard2a = document.getElementById('propertyCard2a');
                const propertyResults2a = document.getElementById('propertyResults2a');
                const propertyCard2b = document.getElementById('propertyCard2b');
                const propertyResults2b = document.getElementById('propertyResults2b');

                // Handle Property 2 subdivision
                if (isSubdivided2El.checked) {
                    propertyCard2.classList.add('hidden');
                    propertyResults2.classList.add('hidden');
                    propertyCard2a.classList.remove('hidden');
                    propertyResults2a.classList.remove('hidden');
                    propertyCard2b.classList.remove('hidden');
                    propertyResults2b.classList.remove('hidden');

                    isPPR2El.checked = false;
                    isPPR2El.disabled = true;
                    isPPR2aEl.disabled = false;
                    isPPR2bEl.disabled = false;

                    propertyCard2a.classList.add('subdivided-property-section');
                    propertyResults2a.classList.add('subdivided-property-section');
                    propertyCard2b.classList.add('subdivided-property-section');
                    propertyResults2b.classList.add('subdivided-property-section');

                } else {
                    propertyCard2.classList.remove('hidden');
                    propertyResults2.classList.remove('hidden');
                    propertyCard2a.classList.add('hidden');
                    propertyResults2a.classList.add('hidden');
                    propertyCard2b.classList.add('hidden');
                    propertyResults2b.classList.add('hidden');

                    isPPR2El.disabled = false;
                    isPPR2aEl.checked = false;
                    isPPR2aEl.disabled = true;
                    isPPR2bEl.checked = false;
                    isPPR2bEl.disabled = true;

                    propertyCard2a.classList.remove('subdivided-property-section');
                    propertyResults2a.classList.remove('subdivided-property-section');
                    propertyCard2b.classList.remove('subdivided-property-section');
                    propertyResults2b.classList.remove('subdivided-property-section');
                }

                // Get user income and calculate tax rate
                const userIncome = parseNumber(document.getElementById('userIncome').value);
                const calculatedTaxRate = calculateMarginalTaxRate(userIncome);
                document.getElementById('calculatedTaxRate').textContent = `${(calculatedTaxRate * 100).toFixed(2)}%`;

                // Re-render expenses for all properties to ensure agent fees and land tax are updated based on latest rent/property value
                Object.keys(currentExpenses).forEach(propId => renderExpenses(propId));

                // Calculate properties
                const propertiesData = [];
                const prop1Data = calculateProperty('1');
                if (prop1Data) propertiesData.push(prop1Data);

                const prop3Data = calculateProperty('3');
                if (prop3Data) propertiesData.push(prop3Data);

                if (isSubdivided2El.checked) {
                    const prop2aData = calculateProperty('2a');
                    if (prop2aData) propertiesData.push(prop2aData);
                    const prop2bData = calculateProperty('2b');
                    if (prop2bData) propertiesData.push(prop2bData);
                } else {
                    const prop2Data = calculateProperty('2');
                    if (prop2Data) propertiesData.push(prop2Data);
                }

                // Update overall summary
                const propertiesForGearingSummary = propertiesData.filter(p => p && !p.isPPR);
                const overallTotalIncome = propertiesForGearingSummary.reduce((sum, p) => sum + p.annualRentalIncome, 0);
                const overallTotalExpenses = propertiesForGearingSummary.reduce((sum, p) => sum + p.totalDeductibleExpenses, 0);
                const overallNetRentalLoss = propertiesForGearingSummary.reduce((sum, p) => sum + p.netRentalLoss, 0);
                const totalAnnualPrincipalPaid = propertiesData.reduce((sum, p) => sum + (p?.annualPrincipalPaid || 0), 0);
                const potentialTaxBenefit = overallNetRentalLoss < 0 ? Math.abs(overallNetRentalLoss) * calculatedTaxRate : 0;

                document.getElementById('overallTotalIncome').textContent = formatCurrency(overallTotalIncome);
                document.getElementById('overallTotalExpenses').textContent = formatCurrency(overallTotalExpenses);
                document.getElementById('overallAnnualPrincipalPaid').textContent = formatCurrency(totalAnnualPrincipalPaid);

                const overallNetRentalLossEl = document.getElementById('overallNetRentalLoss');
                overallNetRentalLossEl.innerHTML = `<span>Overall Net Rental Income/Loss:</span><span>${formatCurrency(overallNetRentalLoss)}</span>`;
                overallNetRentalLossEl.className = `flex justify-between items-center p-4 bg-white rounded-lg text-xl font-bold ${overallNetRentalLoss < 0 ? 'text-purple-800' : 'text-green-800'}`;

                const overallNegativeGearingTextEl = document.getElementById('overallNegativeGearingText');
                const potentialTaxBenefitContainer = document.getElementById('potentialTaxBenefitContainer');
                const taxBenefitNote = document.getElementById('taxBenefitNote');
                const calculateTaxBenefitButton = document.getElementById('calculateTaxBenefitButton');

                if (overallNetRentalLoss < 0) {
                    overallNegativeGearingTextEl.className = "text-center text-purple-700 text-lg p-3 bg-white rounded-lg";
                    overallNegativeGearingTextEl.innerHTML = `Your combined deductible properties show a total negative gearing deduction of <span class="font-bold">${formatCurrency(Math.abs(overallNetRentalLoss))}</span>.`;
                    potentialTaxBenefitContainer.classList.remove('hidden');
                    taxBenefitNote.classList.remove('hidden');
                    calculateTaxBenefitButton.classList.remove('hidden');
                    document.getElementById('potentialTaxBenefit').textContent = formatCurrency(potentialTaxBenefit);
                } else {
                    overallNegativeGearingTextEl.className = "text-center text-green-700 text-lg p-3 bg-white rounded-lg";
                    overallNegativeGearingTextEl.innerHTML = `Your combined deductible properties are positively geared, generating a net income.`;
                    potentialTaxBenefitContainer.classList.add('hidden');
                    taxBenefitNote.classList.add('hidden');
                    calculateTaxBenefitButton.classList.add('hidden');
                }

                // Calculate Overall End of Year Cash Flow
                let totalAllRents = 0;
                let totalInterestExpenses = 0;
                let totalActualExpensesExcludingDepreciation = 0;
                let totalPrincipalPayments = 0;

                propertiesData.forEach(p => {
                    if (!p) return; // Skip if property data is null

                    // For cash flow, we consider all rents and principal payments regardless of PPR status
                    totalAllRents += p.annualRentalIncome;
                    totalPrincipalPayments += p.annualPrincipalPaid;

                    // Interest and other actual expenses (excluding depreciation) are considered for non-PPR properties for the user's specific cash flow definition
                    if (!p.isPPR) {
                        totalInterestExpenses += p.deductibleInterest;
                        totalActualExpensesExcludingDepreciation += p.totalActualExpensesExcludingDepreciation;
                    }
                });

                const overallEndOfYearCashFlow = userIncome + totalAllRents - totalInterestExpenses - totalActualExpensesExcludingDepreciation - totalPrincipalPayments;
                document.getElementById('cashFlowAmount').textContent = formatCurrency(overallEndOfYearCashFlow);
                document.getElementById('overallEndOfYearCashFlow').classList.remove('text-negative', 'text-positive');
                document.getElementById('overallEndOfYearCashFlow').classList.add(overallEndOfYearCashFlow < 0 ? 'text-negative' : 'text-positive');


                populateCashFlowTable(propertiesData, userIncome, rentalGrowthRate, expenseInflationRate);

            } catch (error) {
                console.error("An error occurred during calculation:", error);
            }
        };

        // Function to save current state to local storage
        const saveCalculation = () => {
            const dataToSave = {};
            // Save general inputs
            document.querySelectorAll('input[type="text"], input[type="checkbox"], select').forEach(input => {
                // Only save inputs that are not part of the dynamic expense list
                if (!input.closest('.expense-item')) {
                    if (input.type === 'checkbox') {
                        dataToSave[input.id] = input.checked;
                    } else {
                        dataToSave[input.id] = input.value;
                    }
                }
            });

            // Save currentExpenses (which includes all default and custom expenses with their current values)
            dataToSave['currentExpenses'] = currentExpenses;

            localStorage.setItem('propertyCalculatorData', JSON.stringify(dataToSave));
            alert('Calculation saved successfully!');
        };

        // Function to load state from local storage
        const loadCalculation = () => {
            const savedData = localStorage.getItem('propertyCalculatorData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // Reset to default first to clear any existing custom fields and ensure default structure
                resetAllFields();

                // Load general inputs (excluding expenses, which are handled by currentExpenses)
                for (const id in data) {
                    if (id === 'currentExpenses') {
                        // Load expenses data into currentExpenses object
                        currentExpenses = data[id];
                        // Re-render expenses for all properties based on loaded data
                        Object.keys(currentExpenses).forEach(propId => renderExpenses(propId));
                    } else {
                        const input = document.getElementById(id);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = data[id];
                            } else {
                                input.value = data[id];
                            }
                        }
                    }
                }
                calculateAll(); // Recalculate after loading data
                alert('Calculation loaded successfully!');
            } else {
                alert('No saved calculation found.');
            }
        };

        // Function to reset all fields to their default values
        const resetAllFields = () => {
            // Reset general inputs (excluding expense inputs)
            document.querySelectorAll('input[type="text"]:not([data-is-depreciation]):not([data-is-land-tax]):not([data-expense-name])').forEach(input => {
                input.value = input.defaultValue;
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = checkbox.defaultChecked; // Reset to initial HTML checked state
                checkbox.disabled = false; // Re-enable all checkboxes
            });
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0; // Reset to first option
                select.disabled = false; // Re-enable all selects
            });
            
            // Reset currentExpenses to default and re-render all expense sections
            currentExpenses = JSON.parse(JSON.stringify(defaultExpenses));
            Object.keys(currentExpenses).forEach(propId => renderExpenses(propId));

            calculateAll(); // Recalculate after reset
        };

        // Initialize calculator on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initial render of default expenses for all properties
            Object.keys(currentExpenses).forEach(propId => renderExpenses(propId));

            // Event listeners for all relevant inputs
            document.querySelectorAll('input[type="text"], input[type="checkbox"], select').forEach(input => {
                input.addEventListener('input', calculateAll);
                input.addEventListener('change', calculateAll); // For select and checkboxes
            });

            // Specific event listeners for checkboxes that control section visibility/disabling
            document.getElementById('isPPR1').addEventListener('change', calculateAll);
            document.getElementById('isPPR2').addEventListener('change', calculateAll);
            document.getElementById('isPPR2a').addEventListener('change', calculateAll);
            document.getElementById('isPPR2b').addEventListener('change', calculateAll);
            document.getElementById('isPPR3').addEventListener('change', calculateAll);

            document.getElementById('isSold3').addEventListener('change', calculateAll);
            document.getElementById('soldMonth3').addEventListener('change', calculateAll);

            document.getElementById('isSubdivided2').addEventListener('change', calculateAll);

            document.getElementById('resetButton').addEventListener('click', resetAllFields);
            document.getElementById('saveButton').addEventListener('click', saveCalculation);
            document.getElementById('loadButton').addEventListener('click', loadCalculation);
            document.getElementById('calculateTaxBenefitButton').addEventListener('click', calculateAll); // Ensure this also triggers full recalculation

            // Add event listeners for "Add Custom Expense" buttons
            document.querySelectorAll('.add-expense-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const propertyId = event.target.dataset.propertyId;
                    addCustomExpenseField(propertyId);
                });
            });

            // Initial calculation
            calculateAll();
        });
    </script>
</body>
</html>